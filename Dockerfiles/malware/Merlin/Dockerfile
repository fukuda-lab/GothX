FROM ubuntu:focal AS builder

ARG MERLIN_RELEASE_VER=v1.2.1

RUN apt update && apt install -y --no-install-recommends \
    ca-certificates \
    wget \
    p7zip-full \
    git \
    gcc \
    make \
    libpcap-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /opt/merlin

RUN wget https://github.com/Ne0nd0g/merlin/releases/download/$MERLIN_RELEASE_VER/merlinServer-Linux-x64.7z \
    && 7z x -pmerlin merlinServer-Linux-x64.7z

WORKDIR /opt/hping3
RUN git clone https://github.com/antirez/hping . &&\
    sed --in-place 's|<net/bpf.h>|<pcap-bpf.h>|g' libpcap_stuff.c &&\
    sed --in-place 's|<net/bpf.h>|<pcap-bpf.h>|g' script.c &&\
    ./configure --no-tcl &&\
    make hping3-static

FROM ubuntu:focal

WORKDIR /opt/merlin
COPY --from=builder /opt/merlin/data data
COPY --from=builder /opt/merlin/merlinServer-Linux-x64 ./
COPY --from=builder /opt/merlin/data/bin/linux/merlinAgent-Linux-x64 ./

COPY --from=builder /opt/hping3/hping3-static /opt/hping3/hping3-static

CMD ["./merlinServer-Linux-x64"]
